<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºè¯­éŸ³äº¤äº’æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #333;
            margin-top: 0;
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 12px 24px;
            margin: 10px 5px 0 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-connect {
            background: #4CAF50;
            color: white;
        }

        .btn-disconnect {
            background: #f44336;
            color: white;
        }

        .btn-record {
            background: #2196F3;
            color: white;
        }

        .btn-stop {
            background: #ff9800;
            color: white;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #log {
            background: #1e1e1e;
            color: #61dafb;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .success {
            color: #98c379;
        }

        .error {
            color: #e06c75;
        }

        .warning {
            color: #e5c07b;
        }

        .info {
            color: #61afef;
        }

        #status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        #status.disconnected {
            background: #fee;
            color: #c33;
        }

        #status.connected {
            background: #d4edda;
            color: #155724;
        }

        #status.recording {
            background: #fff3cd;
            color: #856404;
        }

        #status.playing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="box">
        <h2>ğŸ¤ å°æ™ºè¯­éŸ³äº¤äº’æµ‹è¯•</h2>
        <div id="status" class="disconnected">âš« æœªè¿æ¥</div>

        <label>ä»£ç†åœ°å€:</label>
        <input type="text" id="proxyUrl" value="ws://127.0.0.1:8080/api/ws-proxy" readonly>

        <label>Token:</label>
        <input type="text" id="token" value="622121be-663d-44d7-b65a-8763f4502e2c">

        <label>Device ID:</label>
        <input type="text" id="deviceId" value="58:11:22:b7:26:42">

        <div class="controls">
            <button class="btn-connect" onclick="connect()" id="btnConnect">ğŸ”Œ è¿æ¥</button>
            <button class="btn-disconnect" onclick="disconnect()" id="btnDisconnect" disabled>æ–­å¼€</button>
            <button class="btn-record" onclick="startRecording()" id="btnRecord" disabled>ğŸ¤ å¼€å§‹å½•éŸ³</button>
            <button class="btn-stop" onclick="stopRecording()" id="btnStop" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">è¿æ¥çŠ¶æ€</div>
                <div class="stat-value" id="statConnection">æœªè¿æ¥</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å½•éŸ³çŠ¶æ€</div>
                <div class="stat-value" id="statRecording">æœªå½•éŸ³</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ’­æ”¾çŠ¶æ€</div>
                <div class="stat-value" id="statPlaying">æœªæ’­æ”¾</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">éŸ³é¢‘æ•°æ®</div>
                <div class="stat-value" id="statAudioData">0 å­—èŠ‚</div>
            </div>
        </div>
    </div>

    <div class="box">
        <h2>ğŸ“ äº¤äº’æ—¥å¿—</h2>
        <div id="log">ç­‰å¾…è¿æ¥...</div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="../js/protocol.js"></script>
    <script src="../js/audio_recorder.js"></script>
    <script src="../js/audio_player.js"></script>

    <script>
        // å…¨å±€å¯¹è±¡
        let protocol = null;
        let audioRecorder = null;
        let audioPlayer = null;
        let totalAudioSent = 0;
        let totalAudioReceived = 0;

        // æ—¥å¿—å‡½æ•°
        function log(msg, type = '') {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const cls = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            div.innerHTML += `<div class="${cls}">[${time}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function setStatus(state, text) {
            const status = document.getElementById('status');
            status.className = state;
            status.textContent = text;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('statConnection').textContent = protocol && protocol.connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
            document.getElementById('statRecording').textContent = audioRecorder && audioRecorder.isRecording ? 'å½•éŸ³ä¸­' : 'æœªå½•éŸ³';
            document.getElementById('statPlaying').textContent = audioPlayer && audioPlayer.isPlaying ? 'æ’­æ”¾ä¸­' : 'æœªæ’­æ”¾';
            document.getElementById('statAudioData').textContent = `å‘é€ ${(totalAudioSent / 1024).toFixed(1)}KB / æ¥æ”¶ ${(totalAudioReceived / 1024).toFixed(1)}KB`;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            const connected = protocol && protocol.connected;
            const recording = audioRecorder && audioRecorder.isRecording;

            document.getElementById('btnConnect').disabled = connected;
            document.getElementById('btnDisconnect').disabled = !connected;
            document.getElementById('btnRecord').disabled = !connected || recording;
            document.getElementById('btnStop').disabled = !recording;
        }

        // è¿æ¥åˆ°æœåŠ¡å™¨
        async function connect() {
            try {
                const token = document.getElementById('token').value.trim();
                const deviceId = document.getElementById('deviceId').value.trim();
                const proxyUrl = document.getElementById('proxyUrl').value;

                if (!token) {
                    alert('è¯·è¾“å…¥ Tokenï¼');
                    return;
                }

                log('ğŸ”Œ å¼€å§‹è¿æ¥...', 'info');
                setStatus('disconnected', 'â³ è¿æ¥ä¸­...');

                // åˆ›å»ºåè®®å¯¹è±¡
                const config = {
                    ACCESS_TOKEN: token,
                    DEVICE_ID: deviceId,
                    CLIENT_ID: 'web-voice-client',
                    AUDIO: {
                        FORMAT: 'opus',
                        SAMPLE_RATE: 16000,
                        CHANNELS: 1,
                        FRAME_DURATION: 20
                    }
                };

                protocol = new XiaozhiProtocol(config);

                // è®¾ç½®å›è°ƒ
                protocol.onConnected = (message) => {
                    log('âœ… WebSocket è¿æ¥æˆåŠŸï¼', 'success');
                    log(`ğŸ‰ Session ID: ${message.session_id}`, 'success');
                    setStatus('connected', 'ğŸŸ¢ å·²è¿æ¥');
                    updateButtons();
                    updateStats();

                    // åˆå§‹åŒ–éŸ³é¢‘
                    initializeAudio();
                };

                protocol.onDisconnected = (reason) => {
                    log(`ğŸ”Œ è¿æ¥å·²æ–­å¼€: ${reason}`, 'warning');
                    setStatus('disconnected', 'âš« æœªè¿æ¥');
                    updateButtons();
                    updateStats();
                };

                protocol.onJsonMessage = (message) => {
                    log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');

                    // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                    if (message.type === 'transcription') {
                        log(`ğŸ“ è¯†åˆ«ç»“æœ: ${message.text}`, 'success');
                    } else if (message.type === 'response') {
                        log(`ğŸ’¬ å°æ™ºå›å¤: ${message.text}`, 'success');
                    } else if (message.type === 'error') {
                        log(`âš ï¸ é”™è¯¯: ${message.message}`, 'error');
                    }
                };

                protocol.onAudioData = async (audioData) => {
                    log(`ğŸ”Š æ”¶åˆ°éŸ³é¢‘æ•°æ®: ${audioData.byteLength} å­—èŠ‚`, 'info');
                    totalAudioReceived += audioData.byteLength;
                    updateStats();

                    // æ’­æ”¾éŸ³é¢‘
                    if (audioPlayer) {
                        setStatus('playing', 'ğŸ”Š æ’­æ”¾ä¸­...');
                        await audioPlayer.playAudioData(audioData);
                    }
                };

                protocol.onError = (error) => {
                    log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                    setStatus('disconnected', 'âŒ è¿æ¥é”™è¯¯');
                };

                // è¿æ¥
                await protocol.connect();

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                setStatus('disconnected', 'âŒ è¿æ¥å¤±è´¥');
                updateButtons();
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            log('ğŸ”Œ æ–­å¼€è¿æ¥...', 'info');

            if (audioRecorder && audioRecorder.isRecording) {
                audioRecorder.stopRecording();
            }

            if (protocol) {
                protocol.disconnect();
                protocol = null;
            }

            setStatus('disconnected', 'âš« å·²æ–­å¼€');
            updateButtons();
            updateStats();
        }

        // åˆå§‹åŒ–éŸ³é¢‘
        async function initializeAudio() {
            try {
                log('ğŸ¤ åˆå§‹åŒ–éŸ³é¢‘å½•åˆ¶å™¨...', 'info');

                // åˆ›å»ºå½•éŸ³å™¨
                audioRecorder = new AudioRecorder();

                // è®¾ç½®å›è°ƒ
                audioRecorder.onAudioData = (audioData) => {
                    // å‘é€éŸ³é¢‘æ•°æ®åˆ°æœåŠ¡å™¨
                    if (protocol && protocol.connected) {
                        protocol.sendAudio(audioData);
                        totalAudioSent += audioData.length;
                        updateStats();
                    }
                };

                audioRecorder.onError = (error) => {
                    log(`âŒ å½•éŸ³é”™è¯¯: ${error.message}`, 'error');
                };

                // åˆå§‹åŒ–
                await audioRecorder.initialize();
                log('âœ… éŸ³é¢‘å½•åˆ¶å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');

                // åˆ›å»ºæ’­æ”¾å™¨
                log('ğŸ”Š åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨...', 'info');
                audioPlayer = new AudioPlayer();

                // è®¾ç½®å›è°ƒ
                audioPlayer.onPlaybackStart = () => {
                    log('â–¶ï¸ å¼€å§‹æ’­æ”¾éŸ³é¢‘', 'info');
                    setStatus('playing', 'ğŸ”Š æ’­æ”¾ä¸­...');
                    updateStats();
                };

                audioPlayer.onPlaybackEnd = () => {
                    log('â¹ï¸ éŸ³é¢‘æ’­æ”¾å®Œæˆ', 'info');
                    setStatus('connected', 'ğŸŸ¢ å·²è¿æ¥');
                    updateStats();
                };

                audioPlayer.onError = (error) => {
                    log(`âŒ æ’­æ”¾é”™è¯¯: ${error.message}`, 'error');
                };

                // åˆå§‹åŒ–
                await audioPlayer.initialize();
                log('âœ… éŸ³é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');

            } catch (error) {
                log(`âŒ éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                if (!audioRecorder) {
                    log('âŒ å½•éŸ³å™¨æœªåˆå§‹åŒ–', 'error');
                    return;
                }

                log('ğŸ¤ å¼€å§‹å½•éŸ³...', 'info');
                setStatus('recording', 'ğŸ¤ å½•éŸ³ä¸­...');

                // å‘é€å¼€å§‹ç›‘å¬æ¶ˆæ¯
                await protocol.startListening('manual');

                // å¼€å§‹å½•éŸ³
                audioRecorder.startRecording();

                updateButtons();
                updateStats();

            } catch (error) {
                log(`âŒ å¼€å§‹å½•éŸ³å¤±è´¥: ${error.message}`, 'error');
                setStatus('connected', 'ğŸŸ¢ å·²è¿æ¥');
            }
        }

        // åœæ­¢å½•éŸ³
        async function stopRecording() {
            try {
                if (!audioRecorder) {
                    log('âŒ å½•éŸ³å™¨æœªåˆå§‹åŒ–', 'error');
                    return;
                }

                log('â¹ï¸ åœæ­¢å½•éŸ³...', 'info');

                // åœæ­¢å½•éŸ³
                audioRecorder.stopRecording();

                // å‘é€åœæ­¢ç›‘å¬æ¶ˆæ¯
                await protocol.stopListening();

                setStatus('connected', 'ğŸŸ¢ å·²è¿æ¥');
                updateButtons();
                updateStats();

            } catch (error) {
                log(`âŒ åœæ­¢å½•éŸ³å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'success');
            updateButtons();
            updateStats();
        });

        // é¡µé¢å¸è½½å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (audioRecorder) {
                audioRecorder.dispose();
            }
            if (audioPlayer) {
                audioPlayer.dispose();
            }
            if (protocol) {
                protocol.disconnect();
            }
        });
    </script>
</body>

</html>
