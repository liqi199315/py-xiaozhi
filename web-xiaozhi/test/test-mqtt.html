<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTåè®®æµ‹è¯• - å°æ™ºAI</title>
    <!-- Paho MQTT JavaScript å®¢æˆ·ç«¯ -->
    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-display {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .config-item {
            margin: 8px 0;
            display: flex;
            gap: 10px;
        }

        .config-label {
            color: #666;
            font-weight: 600;
            min-width: 120px;
        }

        .config-value {
            color: #333;
            word-break: break-all;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .log-success { color: #4caf50; }
        .log-error { color: #f44336; background: rgba(244,67,54,0.1); }
        .log-warn { color: #ff9800; }
        .log-info { color: #2196f3; }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background: #4caf50;
            color: white;
        }

        .status-disconnected {
            background: #f44336;
            color: white;
        }

        .status-connecting {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ MQTTåè®®è¿æ¥æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯•ä½¿ç”¨MQTT over WebSocketè¿æ¥å°æ™ºæœåŠ¡å™¨</p>

        <!-- é…ç½®æ˜¾ç¤º -->
        <div class="test-section">
            <div class="section-title">
                ğŸ“‹ MQTTé…ç½®ä¿¡æ¯
            </div>
            <div class="config-display" id="mqttConfig">
                <div class="config-item">
                    <span class="config-label">çŠ¶æ€:</span>
                    <span class="config-value" id="configStatus">ç­‰å¾…åŠ è½½...</span>
                </div>
            </div>
            <button class="btn" onclick="loadConfig()">ğŸ”„ åŠ è½½é…ç½®</button>
            <button class="btn btn-secondary" onclick="resetDevice()">ğŸ—‘ï¸ é‡ç½®è®¾å¤‡</button>
        </div>

        <!-- è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <div class="section-title">
                ğŸš€ è¿æ¥æµ‹è¯•
                <span class="status status-disconnected" id="connectionStatus">æœªè¿æ¥</span>
            </div>
            <button class="btn" id="btnConnect" onclick="testConnection()">ğŸ”— å¼€å§‹è¿æ¥</button>
            <button class="btn btn-secondary" id="btnDisconnect" onclick="disconnect()" disabled>âŒ æ–­å¼€è¿æ¥</button>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="test-section">
            <div class="section-title">ğŸ“ æ—¥å¿—è¾“å‡º</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="../js/device.js"></script>
    <script src="../js/ota.js"></script>
    <script src="../js/mqtt_protocol.js"></script>

    <script>
        let device = null;
        let ota = null;
        let protocol = null;
        let config = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status status-${status}`;
            statusEl.textContent = text;
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                log('å¼€å§‹åŠ è½½é…ç½®...', 'info');

                // åˆå§‹åŒ–è®¾å¤‡
                device = new DeviceIdentity();
                const identity = device.ensureDeviceIdentity();
                log(`è®¾å¤‡ID: ${identity.device_id}`, 'success');

                // åˆå§‹åŒ–OTA
                ota = new OTAManager(device);
                config = await ota.fetchConfig('v2');

                // æ˜¾ç¤ºMQTTé…ç½®
                if (config.mqtt) {
                    const configHtml = `
                        <div class="config-item">
                            <span class="config-label">Endpoint:</span>
                            <span class="config-value">${config.mqtt.endpoint}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Client ID:</span>
                            <span class="config-value">${config.mqtt.client_id}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Username:</span>
                            <span class="config-value">${config.mqtt.username}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Password:</span>
                            <span class="config-value">${config.mqtt.password.substring(0, 20)}...</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Publish Topic:</span>
                            <span class="config-value">${config.mqtt.publish_topic}</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Subscribe Topic:</span>
                            <span class="config-value">${config.mqtt.subscribe_topic}</span>
                        </div>
                    `;
                    document.getElementById('mqttConfig').innerHTML = configHtml;
                    log('âœ… MQTTé…ç½®åŠ è½½æˆåŠŸ', 'success');
                    document.getElementById('btnConnect').disabled = false;
                } else {
                    throw new Error('æœªæ‰¾åˆ°MQTTé…ç½®');
                }

            } catch (error) {
                log(`âŒ åŠ è½½é…ç½®å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('configStatus').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                if (!config || !config.mqtt) {
                    throw new Error('è¯·å…ˆåŠ è½½é…ç½®');
                }

                log('å¼€å§‹è¿æ¥MQTTæœåŠ¡å™¨...', 'info');
                updateStatus('connecting', 'è¿æ¥ä¸­...');
                document.getElementById('btnConnect').disabled = true;

                // åˆ›å»ºåè®®å®ä¾‹
                const protocolConfig = {
                    MQTT_ENDPOINT: config.mqtt.endpoint,
                    MQTT_CLIENT_ID: config.mqtt.client_id,
                    MQTT_USERNAME: config.mqtt.username,
                    MQTT_PASSWORD: config.mqtt.password,
                    MQTT_PUBLISH_TOPIC: config.mqtt.publish_topic,
                    MQTT_SUBSCRIBE_TOPIC: config.mqtt.subscribe_topic,
                    AUDIO: {
                        FORMAT: 'opus',
                        SAMPLE_RATE: 16000,
                        CHANNELS: 1,
                        FRAME_DURATION: 20
                    }
                };

                protocol = new XiaozhiMQTTProtocol(protocolConfig);

                // è®¾ç½®å›è°ƒ
                protocol.onConnected = (message) => {
                    log(`âœ… MQTTè¿æ¥æˆåŠŸ! Session ID: ${message.session_id || 'N/A'}`, 'success');
                    updateStatus('connected', 'å·²è¿æ¥');
                    document.getElementById('btnConnect').disabled = true;
                    document.getElementById('btnDisconnect').disabled = false;
                };

                protocol.onDisconnected = (reason) => {
                    log(`âš ï¸ MQTTè¿æ¥æ–­å¼€: ${reason}`, 'warn');
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    document.getElementById('btnConnect').disabled = false;
                    document.getElementById('btnDisconnect').disabled = true;
                };

                protocol.onJsonMessage = (data) => {
                    log(`æ”¶åˆ°JSONæ¶ˆæ¯: ${JSON.stringify(data)}`, 'info');
                };

                protocol.onError = (error) => {
                    log(`âŒ é”™è¯¯: ${error}`, 'error');
                };

                // è¿æ¥
                await protocol.connect();

            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('disconnected', 'è¿æ¥å¤±è´¥');
                document.getElementById('btnConnect').disabled = false;
            }
        }

        // æ–­å¼€è¿æ¥
        async function disconnect() {
            try {
                if (protocol) {
                    await protocol.disconnect();
                    log('å·²æ–­å¼€è¿æ¥', 'info');
                }
            } catch (error) {
                log(`æ–­å¼€è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é‡ç½®è®¾å¤‡
        function resetDevice() {
            if (confirm('ç¡®å®šè¦é‡ç½®è®¾å¤‡å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚')) {
                localStorage.clear();
                log('è®¾å¤‡å·²é‡ç½®', 'warn');
                location.reload();
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
        window.onload = () => {
            log('ğŸš€ MQTTåè®®æµ‹è¯•å·¥å…·å·²å¯åŠ¨', 'success');
            log('è¯·ç‚¹å‡»"åŠ è½½é…ç½®"å¼€å§‹æµ‹è¯•', 'info');
        };
    </script>
</body>
</html>
