<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.idle { background: #e3f2fd; color: #1976d2; }
        .status.connecting { background: #fff3e0; color: #f57c00; }
        .status.connected { background: #e8f5e9; color: #388e3c; }
        .status.error { background: #ffebee; color: #c62828; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover { background: #45a049; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-entry.info { color: #64b5f6; }
        .log-entry.success { color: #81c784; }
        .log-entry.error { color: #e57373; }
        .log-entry.warn { color: #ffb74d; }
        
        .config-panel {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .config-panel input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .config-panel label {
            display: block;
            margin-top: 10px;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– å°æ™ºWebSocketè¿æ¥æµ‹è¯•</h1>
        
        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="status" class="status idle">
            çŠ¶æ€: æœªè¿æ¥
        </div>
        
        <!-- é…ç½®é¢æ¿ -->
        <div class="config-panel">
            <h3>è¿æ¥é…ç½®</h3>
            <label>WebSocketåœ°å€:</label>
            <input type="text" id="wsUrl" placeholder="wss://your-server.com/ws">
            
            <label>Access Token:</label>
            <input type="text" id="accessToken" placeholder="your_access_token">
            
            <label>Device ID:</label>
            <input type="text" id="deviceId" placeholder="your_device_id">
            
            <label>Client ID:</label>
            <input type="text" id="clientId" placeholder="your_client_id">
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div>
            <button id="btnConnect">è¿æ¥æœåŠ¡å™¨</button>
            <button id="btnDisconnect" disabled>æ–­å¼€è¿æ¥</button>
            <button id="btnStartListen" disabled>å¼€å§‹ç›‘å¬</button>
            <button id="btnStopListen" disabled>åœæ­¢ç›‘å¬</button>
            <button id="btnClearLog">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="log" id="logPanel">
            <div class="log-entry info">ç­‰å¾…è¿æ¥...</div>
        </div>
    </div>
    
    <script src="../js/config.js"></script>
    <script src="../js/protocol.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let protocol = null;
        let isConnected = false;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${status}`;
            statusEl.textContent = `çŠ¶æ€: ${text}`;
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons(connected) {
            document.getElementById('btnConnect').disabled = connected;
            document.getElementById('btnDisconnect').disabled = !connected;
            document.getElementById('btnStartListen').disabled = !connected;
            document.getElementById('btnStopListen').disabled = !connected;
        }
        
        // åˆå§‹åŒ–
        function init() {
            // ä»é…ç½®åŠ è½½é»˜è®¤å€¼
            document.getElementById('wsUrl').value = CONFIG.WEBSOCKET_URL;
            document.getElementById('accessToken').value = CONFIG.ACCESS_TOKEN;
            document.getElementById('deviceId').value = CONFIG.DEVICE_ID;
            document.getElementById('clientId').value = CONFIG.CLIENT_ID;
            
            log('é¡µé¢åˆå§‹åŒ–å®Œæˆ', 'success');
            log('è¯·å¡«å†™è¿æ¥é…ç½®åç‚¹å‡»"è¿æ¥æœåŠ¡å™¨"', 'info');
        }
        
        // è¿æ¥æŒ‰é’®
        document.getElementById('btnConnect').onclick = async () => {
            try {
                updateStatus('connecting', 'æ­£åœ¨è¿æ¥...');
                log('å¼€å§‹è¿æ¥åˆ°æœåŠ¡å™¨...', 'info');
                
                // è¯»å–é…ç½®
                const config = {
                    WEBSOCKET_URL: document.getElementById('wsUrl').value,
                    ACCESS_TOKEN: document.getElementById('accessToken').value,
                    DEVICE_ID: document.getElementById('deviceId').value,
                    CLIENT_ID: document.getElementById('clientId').value,
                    AUDIO: CONFIG.AUDIO
                };
                
                // éªŒè¯é…ç½®
                if (!config.WEBSOCKET_URL) {
                    throw new Error('è¯·è¾“å…¥WebSocketåœ°å€');
                }
                
                // åˆ›å»ºåè®®å®ä¾‹
                protocol = new XiaozhiProtocol(config);
                
                // è®¾ç½®å›è°ƒ
                protocol.onConnected = (message) => {
                    log('âœ… è¿æ¥æˆåŠŸ!', 'success');
                    log(`Session ID: ${message.session_id}`, 'success');
                    updateStatus('connected', 'å·²è¿æ¥');
                    updateButtons(true);
                    isConnected = true;
                };
                
                protocol.onDisconnected = (reason) => {
                    log(`è¿æ¥å·²æ–­å¼€: ${reason}`, 'warn');
                    updateStatus('idle', 'æœªè¿æ¥');
                    updateButtons(false);
                    isConnected = false;
                };
                
                protocol.onJsonMessage = (message) => {
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
                    
                    // å¤„ç†TTSæ¶ˆæ¯
                    if (message.type === 'tts') {
                        if (message.state === 'start') {
                            log(`ğŸ”Š AIå¼€å§‹è¯´è¯: ${message.text}`, 'success');
                        } else if (message.state === 'stop') {
                            log('ğŸ”‡ AIè¯´è¯ç»“æŸ', 'info');
                        }
                    }
                    
                    // å¤„ç†STTæ¶ˆæ¯
                    if (message.type === 'stt') {
                        log(`ğŸ¤ è¯†åˆ«ç»“æœ: ${message.text}`, 'success');
                    }
                };
                
                protocol.onAudioData = (data) => {
                    log(`æ”¶åˆ°éŸ³é¢‘æ•°æ®: ${data.byteLength} å­—èŠ‚`, 'info');
                };
                
                protocol.onError = (error) => {
                    log(`é”™è¯¯: ${error.message}`, 'error');
                    updateStatus('error', 'è¿æ¥é”™è¯¯');
                };
                
                // è¿æ¥
                await protocol.connect();
                
            } catch (error) {
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('error', 'è¿æ¥å¤±è´¥');
                updateButtons(false);
            }
        };
        
        // æ–­å¼€æŒ‰é’®
        document.getElementById('btnDisconnect').onclick = () => {
            if (protocol) {
                protocol.disconnect();
                log('å·²æ–­å¼€è¿æ¥', 'warn');
                updateStatus('idle', 'æœªè¿æ¥');
                updateButtons(false);
            }
        };
        
        // å¼€å§‹ç›‘å¬æŒ‰é’®
        document.getElementById('btnStartListen').onclick = async () => {
            try {
                await protocol.startListening('manual');
                log('âœ… å·²å‘é€å¼€å§‹ç›‘å¬å‘½ä»¤', 'success');
            } catch (error) {
                log(`å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        };
        
        // åœæ­¢ç›‘å¬æŒ‰é’®
        document.getElementById('btnStopListen').onclick = async () => {
            try {
                await protocol.stopListening();
                log('âœ… å·²å‘é€åœæ­¢ç›‘å¬å‘½ä»¤', 'success');
            } catch (error) {
                log(`å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        };
        
        // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
        document.getElementById('btnClearLog').onclick = () => {
            document.getElementById('logPanel').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        };
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = init;
    </script>
</body>
</html>