<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºå®Œæ•´æ¿€æ´»æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        /* é˜¶æ®µå¡ç‰‡ */
        .stage-card {
            background: #f8f9fa;
            border-left: 4px solid #e0e0e0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .stage-card.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            box-shadow: 0 2px 8px rgba(33,150,243,0.3);
        }
        .stage-card.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .stage-card.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .stage-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stage-status {
            font-size: 24px;
        }
        .stage-content {
            color: #666;
            line-height: 1.6;
        }

        /* è®¾å¤‡ä¿¡æ¯ */
        .device-info {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .device-info .info-item {
            margin: 5px 0;
        }
        .device-info .label {
            color: #64b5f6;
            display: inline-block;
            width: 150px;
        }
        .device-info .value {
            color: #aed581;
            word-break: break-all;
        }

        /* éªŒè¯ç æ˜¾ç¤º */
        .verification-code {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            letter-spacing: 8px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(102,126,234,0.4);
        }
        .verification-code .code-label {
            font-size: 16px;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }
        .verification-code .code-value {
            font-size: 48px;
            font-family: 'Courier New', monospace;
        }

        /* æŒ‰é’® */
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }
        button:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s;
        }

        /* æ—¥å¿— */
        .log {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
        }
        .log-entry.info { color: #64b5f6; }
        .log-entry.success { color: #81c784; }
        .log-entry.error { color: #e57373; }
        .log-entry.warn { color: #ffb74d; }

        /* æç¤ºæ¡† */
        .tip-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .tip-box .tip-title {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 8px;
        }
        .tip-box .tip-content {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– å°æ™ºWebå®¢æˆ·ç«¯ - å®Œæ•´æ¿€æ´»æµç¨‹</h1>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <!-- é˜¶æ®µ1: è®¾å¤‡èº«ä»½ -->
        <div class="stage-card" id="stage1">
            <div class="stage-title">
                <span>é˜¶æ®µ1: è®¾å¤‡èº«ä»½å‡†å¤‡</span>
                <span class="stage-status">â³</span>
            </div>
            <div class="stage-content" id="stage1Content">
                ç­‰å¾…å¼€å§‹...
            </div>
        </div>

        <!-- é˜¶æ®µ2: OTAé…ç½® -->
        <div class="stage-card" id="stage2">
            <div class="stage-title">
                <span>é˜¶æ®µ2: è·å–OTAé…ç½®</span>
                <span class="stage-status">â³</span>
            </div>
            <div class="stage-content" id="stage2Content">
                ç­‰å¾…å¼€å§‹...
            </div>
        </div>

        <!-- é˜¶æ®µ3: è®¾å¤‡æ¿€æ´» -->
        <div class="stage-card" id="stage3">
            <div class="stage-title">
                <span>é˜¶æ®µ3: è®¾å¤‡æ¿€æ´»</span>
                <span class="stage-status">â³</span>
            </div>
            <div class="stage-content" id="stage3Content">
                ç­‰å¾…å¼€å§‹...
            </div>
        </div>

        <!-- é˜¶æ®µ4: è¿æ¥æµ‹è¯• -->
        <div class="stage-card" id="stage4">
            <div class="stage-title">
                <span>é˜¶æ®µ4: WebSocketè¿æ¥æµ‹è¯•</span>
                <span class="stage-status">â³</span>
            </div>
            <div class="stage-content" id="stage4Content">
                ç­‰å¾…å¼€å§‹...
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="button-group">
            <button id="btnStart">ğŸš€ å¼€å§‹å®Œæ•´æµç¨‹</button>
            <button id="btnReset">ğŸ”„ é‡ç½®è®¾å¤‡èº«ä»½</button>
            <button id="btnClearLog">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div class="tip-box">
            <div class="tip-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</div>
            <div class="tip-content">
                1. ç‚¹å‡»"å¼€å§‹å®Œæ•´æµç¨‹"è‡ªåŠ¨å®Œæˆæ‰€æœ‰é˜¶æ®µ<br>
                2. å¦‚æœéœ€è¦æ¿€æ´»ï¼Œä¼šæ˜¾ç¤ºéªŒè¯ç ï¼Œè¯·æ‰“å¼€ <a href="https://xiaozhi.me" target="_blank">xiaozhi.me</a> è¾“å…¥<br>
                3. æ¿€æ´»æˆåŠŸåä¼šè‡ªåŠ¨è¿æ¥åˆ°æœåŠ¡å™¨<br>
                4. æµ‹è¯•ç”¨çš„è®¾å¤‡èº«ä»½ä¿å­˜åœ¨æµè§ˆå™¨localStorageä¸­
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="log" id="logPanel">
            <div class="log-entry info">ç³»ç»Ÿå°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹å®Œæ•´æµç¨‹"</div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="../js/device.js"></script>
    <script src="../js/ota.js"></script>
    <script src="../js/activator.js"></script>
    <script src="../js/protocol.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let device = null;
        let ota = null;
        let activator = null;
        let protocol = null;
        let currentStage = 0;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°é˜¶æ®µçŠ¶æ€
        function updateStage(stageNum, status, content) {
            const stageCard = document.getElementById(`stage${stageNum}`);
            const stageContent = document.getElementById(`stage${stageNum}Content`);
            const statusIcon = stageCard.querySelector('.stage-status');

            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            stageCard.classList.remove('active', 'success', 'error');

            // æ·»åŠ æ–°çŠ¶æ€
            if (status === 'active') {
                stageCard.classList.add('active');
                statusIcon.textContent = 'â³';
            } else if (status === 'success') {
                stageCard.classList.add('success');
                statusIcon.textContent = 'âœ…';
            } else if (status === 'error') {
                stageCard.classList.add('error');
                statusIcon.textContent = 'âŒ';
            }

            // æ›´æ–°å†…å®¹
            if (content) {
                stageContent.innerHTML = content;
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // é˜¶æ®µ1: è®¾å¤‡èº«ä»½å‡†å¤‡
        async function stage1_deviceIdentity() {
            try {
                updateStage(1, 'active', 'æ­£åœ¨ç”Ÿæˆè®¾å¤‡èº«ä»½...');
                updateProgress(10);
                log('å¼€å§‹é˜¶æ®µ1: è®¾å¤‡èº«ä»½å‡†å¤‡', 'info');

                // åˆ›å»ºè®¾å¤‡èº«ä»½
                device = new DeviceIdentity();
                const deviceInfo = device.getDeviceInfo();

                // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
                const content = `
                    <div class="device-info">
                        <div class="info-item">
                            <span class="label">åºåˆ—å·:</span>
                            <span class="value">${deviceInfo.serial_number}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">MACåœ°å€:</span>
                            <span class="value">${deviceInfo.mac_address}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Client ID:</span>
                            <span class="value">${deviceInfo.client_id}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">æ¿€æ´»çŠ¶æ€:</span>
                            <span class="value">${deviceInfo.is_activated ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}</span>
                        </div>
                    </div>
                `;

                updateStage(1, 'success', content);
                updateProgress(25);
                log('âœ… è®¾å¤‡èº«ä»½å‡†å¤‡å®Œæˆ', 'success');
                return true;

            } catch (error) {
                log(`âŒ è®¾å¤‡èº«ä»½å‡†å¤‡å¤±è´¥: ${error.message}`, 'error');
                updateStage(1, 'error', `é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        // é˜¶æ®µ2: è·å–OTAé…ç½®
        async function stage2_otaConfig() {
            try {
                updateStage(2, 'active', 'æ­£åœ¨è¿æ¥OTAæœåŠ¡å™¨...');
                updateProgress(30);
                log('å¼€å§‹é˜¶æ®µ2: è·å–OTAé…ç½®', 'info');

                // åˆ›å»ºOTAç®¡ç†å™¨
                ota = new OTAManager(device);

                // è·å–é…ç½®
                const config = await ota.fetchConfig('v2');

                // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                let content = '<div class="device-info">';

                if (config.websocket) {
                    const isValidToken = config.websocket.token && config.websocket.token !== 'test-token';
                    const tokenStyle = isValidToken ? 'color: #81c784;' : 'color: #e57373;';
                    const tokenWarning = isValidToken ? '' : ' âš ï¸ (æ— æ•ˆ)';

                    content += `
                        <div class="info-item">
                            <span class="label">WebSocket URL:</span>
                            <span class="value">${config.websocket.url}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Access Token:</span>
                            <span class="value" style="${tokenStyle}">${config.websocket.token}${tokenWarning}</span>
                        </div>
                    `;

                    // å¦‚æœtokenæ— æ•ˆï¼Œæ·»åŠ è­¦å‘Š
                    if (!isValidToken) {
                        content += `
                            <div class="info-item" style="color: #ff9800; background: #fff3e0; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>âš ï¸ è­¦å‘Š:</strong> Access Tokenæ— æ•ˆï¼<br>
                                è¿™é€šå¸¸æ„å‘³ç€è®¾å¤‡æœªæ­£ç¡®æ¿€æ´»ã€‚<br>
                                <strong>å»ºè®®:</strong> ç‚¹å‡»ä¸‹æ–¹"é‡ç½®è®¾å¤‡èº«ä»½"æŒ‰é’®é‡æ–°æ¿€æ´»ã€‚
                            </div>
                        `;
                    }
                }

                if (config.need_activation) {
                    content += `
                        <div class="info-item" style="color: #ffb74d;">
                            <span class="label">âš ï¸ æ¿€æ´»çŠ¶æ€:</span>
                            <span class="value">éœ€è¦æ¿€æ´»</span>
                        </div>
                    `;
                } else {
                    content += `
                        <div class="info-item" style="color: #81c784;">
                            <span class="label">âœ… æ¿€æ´»çŠ¶æ€:</span>
                            <span class="value">å·²æ¿€æ´»</span>
                        </div>
                    `;
                }

                content += '</div>';

                // æ£€æŸ¥tokenæœ‰æ•ˆæ€§
                const isValidToken = config.websocket?.token && config.websocket.token !== 'test-token';

                // å¦‚æœéœ€è¦æ¿€æ´»ï¼Œtokenæ— æ•ˆæ˜¯æ­£å¸¸çš„ï¼Œä¸åº”è¯¥æŠ¥é”™
                if (!isValidToken && !config.need_activation) {
                    updateStage(2, 'error', content);
                    log('âš ï¸ Access Tokenæ— æ•ˆï¼Œä¸”æœåŠ¡å™¨æœªè¿”å›æ¿€æ´»ä¿¡æ¯', 'error');
                    log('è¿™å¯èƒ½æ˜¯æœåŠ¡å™¨é…ç½®é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                    throw new Error('Access Tokenæ— æ•ˆï¼Œä¸”æ— æ³•æ¿€æ´»');
                }

                updateStage(2, 'success', content);
                updateProgress(50);
                log('âœ… OTAé…ç½®è·å–å®Œæˆ', 'success');

                if (config.need_activation) {
                    log('âš ï¸ è®¾å¤‡éœ€è¦æ¿€æ´»ï¼Œå°†è¿›å…¥æ¿€æ´»æµç¨‹', 'warn');
                }

                return config;

            } catch (error) {
                log(`âŒ OTAé…ç½®è·å–å¤±è´¥: ${error.message}`, 'error');
                updateStage(2, 'error', `é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        // é˜¶æ®µ3: è®¾å¤‡æ¿€æ´»
        async function stage3_activation(config) {
            try {
                // å¦‚æœä¸éœ€è¦æ¿€æ´»ï¼Œè·³è¿‡
                if (!config.need_activation) {
                    updateStage(3, 'success', 'è®¾å¤‡å·²æ¿€æ´»ï¼Œæ— éœ€æ¿€æ´»æµç¨‹');
                    updateProgress(75);
                    log('âœ… è®¾å¤‡å·²æ¿€æ´»', 'success');
                    return true;  // è¿”å›trueï¼Œç»§ç»­æ‰§è¡Œé˜¶æ®µ4
                }

                updateStage(3, 'active', 'æ­£åœ¨æ¿€æ´»è®¾å¤‡...');
                updateProgress(55);
                log('å¼€å§‹é˜¶æ®µ3: è®¾å¤‡æ¿€æ´»', 'info');

                // æ˜¾ç¤ºéªŒè¯ç 
                const activation = config.activation;
                const codeDisplay = `
                    <div class="verification-code">
                        <div class="code-label">è¯·åœ¨ xiaozhi.me è¾“å…¥éªŒè¯ç </div>
                        <div class="code-value">${activation.code}</div>
                    </div>
                    <div style="text-align: center; color: #666; margin-top: 10px;">
                        æ­£åœ¨ç­‰å¾…æ¿€æ´»... (æœ€å¤šç­‰å¾…5åˆ†é’Ÿ)
                    </div>
                `;
                updateStage(3, 'active', codeDisplay);

                log(`è¯·åœ¨ xiaozhi.me è¾“å…¥éªŒè¯ç : ${activation.code}`, 'warn');

                // åˆ›å»ºæ¿€æ´»å™¨
                activator = new DeviceActivator(device, ota);

                // å¼€å§‹æ¿€æ´»
                const success = await activator.activate(activation.challenge, activation.code);

                if (success) {
                    // æ¿€æ´»æˆåŠŸï¼Œæ ‡è®°æœ¬åœ°çŠ¶æ€
                    device.setActivationStatus(true);

                    // æ¸…é™¤æ—§çš„OTAé…ç½®ç¼“å­˜
                    localStorage.removeItem('xiaozhi_ota_config');
                    log('ğŸ—‘ï¸ å·²æ¸…é™¤æ—§çš„OTAé…ç½®ç¼“å­˜', 'info');

                    updateStage(3, 'active', `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‰</div>
                            <div style="font-size: 20px; font-weight: bold; color: #4caf50; margin-bottom: 15px;">
                                è®¾å¤‡æ¿€æ´»æˆåŠŸï¼
                            </div>
                            <div style="color: #666; line-height: 1.8;">
                                <p>âœ… è®¾å¤‡å·²æˆåŠŸæ¿€æ´»å¹¶ç»‘å®šåˆ°æ‚¨çš„è´¦å·</p>
                                <p>â³ æ­£åœ¨è‡ªåŠ¨è·å–çœŸå®Token...</p>
                            </div>
                        </div>
                    `);

                    log('âœ… è®¾å¤‡æ¿€æ´»æˆåŠŸï¼', 'success');
                    log('â³ ç­‰å¾…3ç§’åé‡æ–°è·å–é…ç½®...', 'info');

                    // ç­‰å¾…3ç§’ï¼Œè®©æœåŠ¡å™¨å¤„ç†æ¿€æ´»
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    // å°è¯•æœ€å¤š5æ¬¡é‡æ–°è·å–é…ç½®
                    const maxRetries = 5;
                    let retryCount = 0;
                    let newConfig = null;

                    while (retryCount < maxRetries) {
                        retryCount++;
                        log(`ğŸ”„ ç¬¬${retryCount}æ¬¡å°è¯•è·å–æ–°é…ç½®...`, 'info');

                        try {
                            // é‡æ–°è·å–é…ç½®
                            newConfig = await ota.fetchConfig('v2');

                            // æ£€æŸ¥æ˜¯å¦è·å–åˆ°çœŸå®token
                            const newToken = newConfig.websocket?.token;
                            const isValidToken = newToken && newToken !== 'test-token';

                            if (isValidToken) {
                                log(`âœ… æˆåŠŸè·å–çœŸå®Token: ${newToken}`, 'success');

                                const successContent = `
                                    <div style="text-align: center; padding: 20px;">
                                        <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #4caf50; margin-bottom: 15px;">
                                            æ¿€æ´»æˆåŠŸï¼Tokenå·²è·å–
                                        </div>
                                        <div style="color: #666; line-height: 1.8;">
                                            <p>âœ… è®¾å¤‡å·²æ¿€æ´»</p>
                                            <p>âœ… çœŸå®Tokenå·²è·å–</p>
                                            <p>âœ… å‡†å¤‡è¿æ¥WebSocket...</p>
                                        </div>
                                    </div>
                                `;
                                updateStage(3, 'success', successContent);
                                updateProgress(75);

                                // è¿”å›æ–°é…ç½®ï¼Œç»§ç»­æ‰§è¡Œé˜¶æ®µ4
                                return newConfig;
                            }

                            // è¿˜æ˜¯test-tokenï¼Œç»§ç»­é‡è¯•
                            log(`âš ï¸ ç¬¬${retryCount}æ¬¡è·å–ä»æ˜¯test-tokenï¼Œ${retryCount < maxRetries ? 'ç»§ç»­é‡è¯•' : 'è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°'}...`, 'warn');

                            if (retryCount < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 3000));
                            }

                        } catch (error) {
                            log(`âŒ ç¬¬${retryCount}æ¬¡è·å–é…ç½®å¤±è´¥: ${error.message}`, 'error');
                            if (retryCount < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 3000));
                            }
                        }
                    }

                    // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ä»æœªè·å–åˆ°çœŸå®token
                    log('âš ï¸ å¤šæ¬¡å°è¯•åä»æœªè·å–åˆ°çœŸå®Token', 'warn');
                    log('ğŸ’¡ å»ºè®®ï¼šç­‰å¾…1-2åˆ†é’Ÿååˆ·æ–°é¡µé¢é‡è¯•', 'warn');

                    const fallbackContent = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                            <div style="font-size: 18px; font-weight: bold; color: #ff9800; margin-bottom: 15px;">
                                æ¿€æ´»æˆåŠŸï¼Œä½†Tokenè·å–å»¶è¿Ÿ
                            </div>
                            <div style="color: #666; line-height: 1.8; margin: 15px 0;">
                                <p>âœ… è®¾å¤‡å·²æˆåŠŸæ¿€æ´»</p>
                                <p>âš ï¸ æœåŠ¡å™¨Tokenç”Ÿæˆéœ€è¦æ›´å¤šæ—¶é—´</p>
                                <p>ğŸ’¡ è¯·ç­‰å¾…1-2åˆ†é’Ÿååˆ·æ–°é¡µé¢</p>
                            </div>
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; color: #666;">
                                <strong style="color: #ff9800;">â° å»ºè®®æ“ä½œï¼š</strong><br>
                                1. ç­‰å¾… 1-2 åˆ†é’Ÿ<br>
                                2. åˆ·æ–°é¡µé¢<br>
                                3. ç‚¹å‡»"å¼€å§‹å®Œæ•´æµç¨‹"<br>
                                4. ç³»ç»Ÿå°†è‡ªåŠ¨ä½¿ç”¨çœŸå®Tokenè¿æ¥
                            </div>
                            <button onclick="location.reload()"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                           color: white; border: none; padding: 15px 40px;
                                           font-size: 16px; border-radius: 8px; cursor: pointer;
                                           margin-top: 20px; box-shadow: 0 4px 15px rgba(102,126,234,0.4);">
                                ğŸ”„ åˆ·æ–°é¡µé¢ï¼ˆè¯·å…ˆç­‰å¾…1-2åˆ†é’Ÿï¼‰
                            </button>
                        </div>
                    `;

                    updateStage(3, 'success', fallbackContent);
                    updateProgress(100);

                    // è·³è¿‡é˜¶æ®µ4
                    return 'skip_stage4';

                } else {
                    throw new Error('æ¿€æ´»å¤±è´¥ï¼Œè¯·é‡è¯•');
                }

            } catch (error) {
                log(`âŒ è®¾å¤‡æ¿€æ´»å¤±è´¥: ${error.message}`, 'error');
                updateStage(3, 'error', `é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        // é˜¶æ®µ4: WebSocketè¿æ¥æµ‹è¯•
        async function stage4_connection() {
            try {
                updateStage(4, 'active', 'æ­£åœ¨è¿æ¥WebSocketæœåŠ¡å™¨...');
                updateProgress(80);
                log('å¼€å§‹é˜¶æ®µ4: WebSocketè¿æ¥æµ‹è¯•', 'info');

                const wsUrl = ota.getWebSocketURL();
                const wsToken = ota.getWebSocketToken();
                const deviceInfo = device.getDeviceInfo();

                if (!wsUrl || !wsToken) {
                    throw new Error('ç¼ºå°‘WebSocketé…ç½®');
                }

                log(`WebSocket URL: ${wsUrl}`, 'info');
                log(`Access Token: ${wsToken}`, 'info');

                // åˆ›å»ºåè®®å®ä¾‹
                const config = {
                    WEBSOCKET_URL: wsUrl,
                    ACCESS_TOKEN: wsToken,
                    DEVICE_ID: deviceInfo.device_id,
                    CLIENT_ID: deviceInfo.client_id,
                    AUDIO: {
                        FORMAT: 'opus',
                        SAMPLE_RATE: 16000,
                        CHANNELS: 1,
                        FRAME_DURATION: 20
                    }
                };

                protocol = new XiaozhiProtocol(config);

                // è®¾ç½®å›è°ƒ
                protocol.onConnected = (message) => {
                    log(`âœ… WebSocketè¿æ¥æˆåŠŸ! Session ID: ${message.session_id}`, 'success');

                    const content = `
                        <div class="device-info">
                            <div class="info-item">
                                <span class="label">è¿æ¥çŠ¶æ€:</span>
                                <span class="value" style="color: #81c784;">å·²è¿æ¥</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Session ID:</span>
                                <span class="value">${message.session_id}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">ä¼ è¾“æ–¹å¼:</span>
                                <span class="value">${message.transport}</span>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <p style="color: #4caf50; font-weight: bold;">ğŸ‰ æ­å–œï¼æ‰€æœ‰é˜¶æ®µå®Œæˆï¼</p>
                            <p style="color: #666;">ç°åœ¨å¯ä»¥å¼€å§‹ä½¿ç”¨è¯­éŸ³å¯¹è¯åŠŸèƒ½äº†</p>
                        </div>
                    `;

                    updateStage(4, 'success', content);
                    updateProgress(100);
                };

                protocol.onDisconnected = (reason) => {
                    log(`è¿æ¥æ–­å¼€: ${reason}`, 'warn');
                };

                protocol.onError = (error) => {
                    log(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                };

                // è¿æ¥
                await protocol.connect();

            } catch (error) {
                log(`âŒ WebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStage(4, 'error', `é”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        // å®Œæ•´æµç¨‹
        async function runFullProcess() {
            try {
                document.getElementById('btnStart').disabled = true;
                log('========== å¼€å§‹å®Œæ•´æ¿€æ´»æµç¨‹ ==========', 'info');

                // é˜¶æ®µ1
                await stage1_deviceIdentity();
                await sleep(500);

                // é˜¶æ®µ2
                let config = await stage2_otaConfig();
                await sleep(500);

                // é˜¶æ®µ3
                const activationResult = await stage3_activation(config);

                // å¦‚æœæ¿€æ´»æˆåŠŸå¹¶è¿”å›äº†æ–°é…ç½®ï¼Œä½¿ç”¨æ–°é…ç½®
                if (activationResult && typeof activationResult === 'object' && activationResult.websocket) {
                    log('âœ… ä½¿ç”¨æ¿€æ´»åè·å–çš„æ–°é…ç½®', 'success');
                    config = activationResult;  // æ›´æ–°configä¸ºæ–°é…ç½®
                    await sleep(500);

                    // ç»§ç»­æ‰§è¡Œé˜¶æ®µ4ï¼Œä½¿ç”¨æ–°çš„çœŸå®token
                    await stage4_connection();
                    log('========== å®Œæ•´æµç¨‹æˆåŠŸå®Œæˆï¼ ==========', 'success');
                } else if (activationResult === 'skip_stage4') {
                    // æ¿€æ´»æˆåŠŸä½†æœªè·å–åˆ°çœŸå®tokenï¼Œéœ€è¦åˆ·æ–°
                    log('========== æ¿€æ´»å®Œæˆï¼Œè¯·ç­‰å¾…ååˆ·æ–°é¡µé¢ï¼ ==========', 'warn');
                    return;  // ç»ˆæ­¢æµç¨‹
                } else {
                    // è®¾å¤‡å·²æ¿€æ´»ï¼Œç›´æ¥è¿æ¥
                    await sleep(500);
                    await stage4_connection();
                    log('========== å®Œæ•´æµç¨‹æˆåŠŸå®Œæˆï¼ ==========', 'success');
                }

            } catch (error) {
                log(`æµç¨‹ä¸­æ–­: ${error.message}`, 'error');
            } finally {
                document.getElementById('btnStart').disabled = false;
            }
        }

        // é‡ç½®è®¾å¤‡
        function resetDevice() {
            if (confirm('ç¡®å®šè¦é‡ç½®è®¾å¤‡èº«ä»½å—ï¼Ÿè¿™å°†æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ‰€æœ‰è®¾å¤‡ä¿¡æ¯ã€‚')) {
                localStorage.clear();
                log('è®¾å¤‡èº«ä»½å·²é‡ç½®', 'warn');
                location.reload();
            }
        }

        // å·¥å…·å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('btnStart').onclick = runFullProcess;
        document.getElementById('btnReset').onclick = resetDevice;
        document.getElementById('btnClearLog').onclick = () => {
            document.getElementById('logPanel').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        };

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = () => {
            log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'success');
            log('ç‚¹å‡»"å¼€å§‹å®Œæ•´æµç¨‹"ä½“éªŒå®Œæ•´çš„è®¾å¤‡æ¿€æ´»æµç¨‹', 'info');
        };
    </script>
</body>
</html>
