# è±†åŒ…ASRåç«¯çº¿ä¸Šéƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 20.04+ / CentOS 8+ æ¨è) æˆ– Windows Server
- **Pythonç‰ˆæœ¬**: Python 3.9 - 3.13
- **å†…å­˜**: æœ€ä½ 2GBï¼Œæ¨è 4GB+
- **ç¡¬ç›˜**: æœ€ä½ 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: éœ€è¦èƒ½è®¿é—®è±†åŒ…æœåŠ¡å™¨ `wss://openspeech.bytedance.com`

---

## ğŸ”§ ä¾èµ–å®‰è£…

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ requirements.txtï¼ˆæ¨èï¼‰

#### 1. å…‹éš†/ä¸Šä¼ é¡¹ç›®åˆ°æœåŠ¡å™¨
```bash
# ä½¿ç”¨ git
git clone <your-repo-url>
cd py-xiaozhi

# æˆ–è€…ä¸Šä¼ å‹ç¼©åŒ…åè§£å‹
# scp py-xiaozhi.zip user@server:/path/to/
# ssh user@server
# cd /path/to/
# unzip py-xiaozhi.zip
```

#### 2. åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Linux/Mac:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

#### 3. å®‰è£…ä¾èµ–åŒ…

**æ ¸å¿ƒä¾èµ–ï¼ˆæœ€å°åŒ–å®‰è£…ï¼Œä»…WebæœåŠ¡ï¼‰:**
```bash
# åˆ›å»ºç²¾ç®€ç‰ˆ requirements.txt
cat > requirements_web.txt << 'EOF'
# WebæœåŠ¡æ ¸å¿ƒä¾èµ–
aiohttp==3.12.13
websockets==11.0.3
colorlog==6.9.0

# å·¥å…·åº“
requests==2.32.3
python-dateutil==2.9.0.post0
beautifulsoup4==4.12.3
py-machineid==0.8.0
EOF

# å®‰è£…æ ¸å¿ƒä¾èµ–
pip install -r requirements_web.txt
```

**å®Œæ•´ä¾èµ–ï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰:**
```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–
pip install -r requirements.txt

# å¦‚æœæ˜¯ Linux æœåŠ¡å™¨ï¼Œè·³è¿‡ Windows ä¸“ç”¨åº“
pip install -r requirements.txt --no-deps
pip install $(grep -v "sys_platform == \"win32\"" requirements.txt | grep -v "^#" | tr '\n' ' ')
```

---

## ğŸ”‘ é…ç½®è±†åŒ…å‡­è¯

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# ç¼–è¾‘ ~/.bashrc æˆ– ~/.bash_profile
nano ~/.bashrc

# æ·»åŠ ä»¥ä¸‹å†…å®¹
export DOUBAO_APP_KEY="2785683478"
export DOUBAO_ACCESS_KEY="OHl7yBW1VI5M9f4oI26RDU-3xPtkAGZp"

# WebSocketé…ç½®ï¼ˆå¯é€‰ï¼‰
export WEBSOCKET_ACCESS_TOKEN="your-xiaozhi-token"
export DEVICE_ID="your-device-id"
export CLIENT_ID="your-client-id"

# WebæœåŠ¡é…ç½®
export XIAOZHI_WEB_HOST="0.0.0.0"  # ç›‘å¬æ‰€æœ‰ç½‘å¡
export XIAOZHI_WEB_PORT="8080"

# é‡æ–°åŠ è½½é…ç½®
source ~/.bashrc
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ .env æ–‡ä»¶

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env æ–‡ä»¶
cat > .env << 'EOF'
# è±†åŒ…ASRå‡­è¯
DOUBAO_APP_KEY=2785683478
DOUBAO_ACCESS_KEY=OHl7yBW1VI5M9f4oI26RDU-3xPtkAGZp

# å°æ™ºWebSocketé…ç½®
WEBSOCKET_ACCESS_TOKEN=your-token
DEVICE_ID=your-device-id
CLIENT_ID=your-client-id

# WebæœåŠ¡é…ç½®
XIAOZHI_WEB_HOST=0.0.0.0
XIAOZHI_WEB_PORT=8080
EOF

# å®‰è£… python-dotenv è¯»å– .env
pip install python-dotenv
```

ç„¶ååœ¨ `main_web.py` å¼€å¤´æ·»åŠ ï¼š
```python
from dotenv import load_dotenv
load_dotenv()  # åŠ è½½ .env æ–‡ä»¶
```

---

## ğŸš€ å¯åŠ¨æœåŠ¡

### å¼€å‘/æµ‹è¯•æ¨¡å¼

```bash
# ç›´æ¥å¯åŠ¨ï¼ˆå‰å°è¿è¡Œï¼‰
python main_web.py --skip-activation --web-host 0.0.0.0 --web-port 8080

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/xiaozhi.log
```

### ç”Ÿäº§æ¨¡å¼ï¼ˆæ¨èï¼‰

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ systemd æœåŠ¡ï¼ˆLinux æ¨èï¼‰

```bash
# åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
sudo nano /etc/systemd/system/xiaozhi-web.service
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š
```ini
[Unit]
Description=XiaoZhi AI Web Service
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/path/to/py-xiaozhi
Environment="PATH=/path/to/py-xiaozhi/venv/bin"
Environment="DOUBAO_APP_KEY=2785683478"
Environment="DOUBAO_ACCESS_KEY=OHl7yBW1VI5M9f4oI26RDU-3xPtkAGZp"
Environment="XIAOZHI_WEB_HOST=0.0.0.0"
Environment="XIAOZHI_WEB_PORT=8080"
ExecStart=/path/to/py-xiaozhi/venv/bin/python main_web.py --skip-activation --web-host 0.0.0.0 --web-port 8080
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start xiaozhi-web

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable xiaozhi-web

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status xiaozhi-web

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u xiaozhi-web -f
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨ screen/tmuxï¼ˆç®€å•ï¼‰

```bash
# å®‰è£… screen
sudo apt install screen  # Ubuntu/Debian
sudo yum install screen  # CentOS/RHEL

# åˆ›å»ºä¼šè¯
screen -S xiaozhi

# å¯åŠ¨æœåŠ¡
cd /path/to/py-xiaozhi
source venv/bin/activate
python main_web.py --skip-activation --web-host 0.0.0.0 --web-port 8080

# æŒ‰ Ctrl+A, D é€€å‡ºä¼šè¯ï¼ˆæœåŠ¡ç»§ç»­è¿è¡Œï¼‰

# é‡æ–°è¿æ¥
screen -r xiaozhi

# æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
screen -ls
```

#### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ Supervisorï¼ˆæ¨èï¼‰

```bash
# å®‰è£… Supervisor
sudo apt install supervisor  # Ubuntu/Debian
sudo yum install supervisor  # CentOS/RHEL

# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo nano /etc/supervisor/conf.d/xiaozhi-web.conf
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š
```ini
[program:xiaozhi-web]
command=/path/to/py-xiaozhi/venv/bin/python main_web.py --skip-activation --web-host 0.0.0.0 --web-port 8080
directory=/path/to/py-xiaozhi
user=your-username
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/path/to/py-xiaozhi/logs/supervisor.log
environment=DOUBAO_APP_KEY="2785683478",DOUBAO_ACCESS_KEY="OHl7yBW1VI5M9f4oI26RDU-3xPtkAGZp",XIAOZHI_WEB_HOST="0.0.0.0",XIAOZHI_WEB_PORT="8080"
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
# é‡æ–°åŠ è½½é…ç½®
sudo supervisorctl reread
sudo supervisorctl update

# å¯åŠ¨æœåŠ¡
sudo supervisorctl start xiaozhi-web

# æŸ¥çœ‹çŠ¶æ€
sudo supervisorctl status xiaozhi-web

# æŸ¥çœ‹æ—¥å¿—
sudo supervisorctl tail -f xiaozhi-web
```

---

## ğŸŒ é…ç½®åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

### ä½¿ç”¨ Nginxï¼ˆæ¨èï¼‰

#### 1. å®‰è£… Nginx
```bash
sudo apt install nginx  # Ubuntu/Debian
sudo yum install nginx  # CentOS/RHEL
```

#### 2. é…ç½® Nginx
```bash
sudo nano /etc/nginx/sites-available/xiaozhi
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š
```nginx
# HTTP é…ç½®
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºä½ çš„åŸŸå

    # é™æ€æ–‡ä»¶
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket ä»£ç†
    location /api/ws-proxy {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # è±†åŒ… ASR WebSocket
    location /api/doubao-asr {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # äº‹ä»¶æµï¼ˆSSEï¼‰
    location /events {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
    }
}
```

#### 3. å¯ç”¨é…ç½®
```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/xiaozhi /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

#### 4. é…ç½® HTTPSï¼ˆæ¨èï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼š
```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦å¹¶è‡ªåŠ¨é…ç½®
sudo certbot --nginx -d your-domain.com

# è¯ä¹¦ä¼šè‡ªåŠ¨ç»­æœŸ
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®

```bash
# å…è®¸ HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å¦‚æœä¸ä½¿ç”¨ Nginxï¼Œç›´æ¥æš´éœ² 8080
sudo ufw allow 8080/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### 2. éšè—æ•æ„Ÿä¿¡æ¯

**ä»ä»£ç ä¸­ç§»é™¤ç¡¬ç¼–ç çš„å‡­è¯ï¼š**

ç¼–è¾‘ `src/plugins/web_server.py` ç¬¬ 473-474 è¡Œï¼š
```python
# ä¿®æ”¹å‰ï¼ˆç¡¬ç¼–ç ï¼‰
app_key = os.getenv("DOUBAO_APP_KEY", "2785683478")
access_key = os.getenv("DOUBAO_ACCESS_KEY", "OHl7yBW1VI5M9f4oI26RDU-3xPtkAGZp")

# ä¿®æ”¹åï¼ˆç§»é™¤é»˜è®¤å€¼ï¼‰
app_key = os.getenv("DOUBAO_APP_KEY")
access_key = os.getenv("DOUBAO_ACCESS_KEY")

if not app_key or not access_key:
    logger.error("[è±†åŒ…ASR] æœªé…ç½®è±†åŒ…å‡­è¯ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ DOUBAO_APP_KEY å’Œ DOUBAO_ACCESS_KEY")
    await ws.send_json({"type": "error", "message": "è±†åŒ…å‡­è¯æœªé…ç½®"})
    await ws.close()
    return ws
```

### 3. é™åˆ¶è®¿é—®æ¥æºï¼ˆå¯é€‰ï¼‰

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š
```nginx
# åªå…è®¸ç‰¹å®šIPè®¿é—®
allow 192.168.1.0/24;  # å…è®¸å±€åŸŸç½‘
deny all;               # æ‹’ç»å…¶ä»–æ‰€æœ‰IP
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—æŸ¥çœ‹

```bash
# åº”ç”¨æ—¥å¿—
tail -f /path/to/py-xiaozhi/logs/xiaozhi.log

# Systemd æ—¥å¿—
sudo journalctl -u xiaozhi-web -f

# Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 2. æ—¥å¿—è½®è½¬ï¼ˆé˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼‰

```bash
# åˆ›å»º logrotate é…ç½®
sudo nano /etc/logrotate.d/xiaozhi
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š
```
/path/to/py-xiaozhi/logs/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
    create 0644 your-username your-username
    sharedscripts
    postrotate
        systemctl reload xiaozhi-web > /dev/null 2>&1 || true
    endscript
}
```

---

## ğŸ§ª æµ‹è¯•éƒ¨ç½²

### 1. æœ¬åœ°æµ‹è¯•
```bash
# æµ‹è¯•HTTPæ¥å£
curl http://localhost:8080/

# æµ‹è¯•é…ç½®æ¥å£
curl http://localhost:8080/api/config

# æµ‹è¯• WebSocketï¼ˆéœ€è¦å·¥å…·ï¼‰
npm install -g wscat
wscat -c ws://localhost:8080/api/doubao-asr
```

### 2. è¿œç¨‹æµ‹è¯•
```bash
# æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨IP/åŸŸå
curl http://your-server-ip:8080/
curl http://your-domain.com/

# æµè§ˆå™¨è®¿é—®
http://your-server-ip:8080/index3.html
http://your-domain.com/index3.html
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ä¾èµ–å®‰è£…å¤±è´¥ï¼Ÿ
```bash
# æ›´æ–° pip
pip install --upgrade pip setuptools wheel

# å®‰è£…ç¼–è¯‘å·¥å…·ï¼ˆLinuxï¼‰
sudo apt install build-essential python3-dev  # Ubuntu/Debian
sudo yum groupinstall "Development Tools"     # CentOS/RHEL

# å•ç‹¬å®‰è£…å¤±è´¥çš„åŒ…
pip install <package-name> --no-cache-dir
```

### Q2: ç«¯å£è¢«å ç”¨ï¼Ÿ
```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :8080
sudo netstat -tulpn | grep 8080

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>

# æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£
python main_web.py --web-port 8081
```

### Q3: æ— æ³•è¿æ¥è±†åŒ…æœåŠ¡å™¨ï¼Ÿ
```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping openspeech.bytedance.com

# æµ‹è¯• HTTPS
curl -I https://openspeech.bytedance.com

# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
sudo iptables -L
```

### Q4: WebSocket è¿æ¥å¤±è´¥ï¼Ÿ
- æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ WebSocket ä»£ç†è®¾ç½®
- ç¡®è®¤é˜²ç«å¢™å…è®¸ WebSocket ç«¯å£
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥åç«¯æ—¥å¿—ä¸­çš„è¿æ¥é”™è¯¯

---

## ğŸ“¦ Docker éƒ¨ç½²ï¼ˆé«˜çº§ï¼‰

### åˆ›å»º Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY requirements_web.txt .
COPY . .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -r requirements_web.txt

# æš´éœ²ç«¯å£
EXPOSE 8080

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV DOUBAO_APP_KEY=2785683478
ENV DOUBAO_ACCESS_KEY=OHl7yBW1VI5M9f4oI26RDU-3xPtkAGZp
ENV XIAOZHI_WEB_HOST=0.0.0.0
ENV XIAOZHI_WEB_PORT=8080

# å¯åŠ¨å‘½ä»¤
CMD ["python", "main_web.py", "--skip-activation", "--web-host", "0.0.0.0", "--web-port", "8080"]
```

### æ„å»ºå’Œè¿è¡Œ

```bash
# æ„å»ºé•œåƒ
docker build -t xiaozhi-web:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name xiaozhi-web \
  -p 8080:8080 \
  -e DOUBAO_APP_KEY=your-key \
  -e DOUBAO_ACCESS_KEY=your-access-key \
  --restart unless-stopped \
  xiaozhi-web:latest

# æŸ¥çœ‹æ—¥å¿—
docker logs -f xiaozhi-web

# åœæ­¢å®¹å™¨
docker stop xiaozhi-web

# åˆ é™¤å®¹å™¨
docker rm xiaozhi-web
```

---

## âœ… éƒ¨ç½²æ¸…å•

- [ ] æœåŠ¡å™¨å‡†å¤‡å°±ç»ªï¼ˆLinux/Windowsï¼‰
- [ ] Python 3.9+ å·²å®‰è£…
- [ ] é¡¹ç›®ä»£ç å·²ä¸Šä¼ 
- [ ] è™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º
- [ ] ä¾èµ–åŒ…å·²å®‰è£…
- [ ] è±†åŒ…å‡­è¯å·²é…ç½®ï¼ˆç¯å¢ƒå˜é‡ï¼‰
- [ ] ä»ä»£ç ä¸­ç§»é™¤ç¡¬ç¼–ç å‡­è¯
- [ ] WebæœåŠ¡å¯ä»¥å¯åŠ¨ï¼ˆå‰å°æµ‹è¯•ï¼‰
- [ ] é…ç½®è¿›ç¨‹ç®¡ç†ï¼ˆsystemd/supervisorï¼‰
- [ ] é…ç½®åå‘ä»£ç†ï¼ˆNginxï¼Œå¯é€‰ï¼‰
- [ ] é…ç½® HTTPS è¯ä¹¦ï¼ˆLet's Encryptï¼Œå¯é€‰ï¼‰
- [ ] é˜²ç«å¢™è§„åˆ™å·²è®¾ç½®
- [ ] æ—¥å¿—è½®è½¬å·²é…ç½®
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] è¿œç¨‹æµ‹è¯•é€šè¿‡
- [ ] è±†åŒ…ASRåŠŸèƒ½æ­£å¸¸

---

**éƒ¨ç½²å®Œæˆï¼ğŸ‰**

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚
